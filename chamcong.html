<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chấm Công - Quản lý</title>
    <style>
        /* CSS giữ nguyên như trước */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* Thanh header cố định */
        .fixed-header {
            background-color: #34495e;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            height: 60px;
        }

        .fixed-header h2 {
            font-size: 1.3rem;
            font-weight: normal;
        }

        .fixed-header .back-btn {
            background-color: transparent;
            border: 1px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .fixed-header .back-btn:hover {
            background-color: #3498db;
            border-color: #3498db;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 60px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            font-size: 0.95rem;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }

        .tab:first-child {
            border-radius: 8px 0 0 0;
        }

        .tab:last-child {
            border-radius: 0 8px 0 0;
        }

        .tab.active {
            background: #3498db;
            color: white;
            font-weight: 500;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .filter-section {
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: end;
        }

        .form-field {
            flex: 1;
            min-width: 150px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .load-btn {
            background-color: #3498db;
            color: white;
            height: 36px;
        }

        .load-btn:hover {
            background-color: #2980b9;
        }

        .save-btn {
            background-color: #2ecc71;
            color: white;
        }

        .save-btn:hover {
            background-color: #27ae60;
        }

        .table-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 10px 12px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        .employee-name {
            text-align: left;
            font-weight: 500;
            background-color: #f1f8ff;
            position: sticky;
            left: 0;
            z-index: 1;
        }

        .day-header {
            background-color: #e8f4fd;
        }

        .weekend {
            background-color: #fff0f0;
        }

        input[type="number"] {
            width: 70px;
            text-align: center;
            padding: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .fixed-header {
                padding: 8px 15px;
                height: 50px;
            }
            
            .fixed-header h2 {
                font-size: 1rem;
            }
            
            .fixed-header .back-btn {
                padding: 4px 8px;
                font-size: 0.85rem;
            }
            
            .container {
                padding: 10px;
                margin-top: 50px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-radius: 0 !important;
            }
            
            .tab:first-child {
                border-radius: 8px 8px 0 0 !important;
            }
            
            .tab:last-child {
                border-radius: 0 0 8px 8px !important;
            }
            
            .filter-section, .table-section {
                padding: 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-field {
                min-width: 100%;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 0.85rem;
            }
            
            input[type="number"] {
                width: 60px;
            }
        }

        @media (max-width: 480px) {
            .fixed-header {
                padding: 6px 10px;
                height: 45px;
            }
            
            .fixed-header h2 {
                font-size: 0.9rem;
            }
            
            .container {
                padding: 8px;
                margin-top: 45px;
            }
            
            .filter-section, .table-section {
                padding: 12px;
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 0.8rem;
            }
            
            input[type="number"] {
                width: 50px;
                padding: 3px;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <header class="fixed-header">
        <h2>Chấm Công - Quản lý</h2>
        <div>
            <button class="back-btn" onclick="window.location.href='dashboard.html'">Quay lại</button>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="weekly">Chấm Công Tuần</button>
            <button class="tab" data-tab="overtime">Chấm Tăng Ca</button>
        </div>

        <!-- Tab Chấm Công Tuần -->
        <div id="weekly-tab" class="tab-content active">
            <div class="filter-section">
                <h3>Lọc dữ liệu chấm công tuần</h3>
                <div class="form-row">
                    <div class="form-field">
                        <label for="yearSelect">Năm</label>
                        <select id="yearSelect">
                            <option value="">-- Chọn năm --</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <label for="monthSelect">Tháng</label>
                        <select id="monthSelect">
                            <option value="">-- Chọn tháng --</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <label for="weekSelect">Tuần</label>
                        <select id="weekSelect">
                            <option value="">-- Chọn tuần --</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <label for="teamSelect">Đội</label>
                        <select id="teamSelect">
                            <option value="">-- Chọn đội --</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <button class="btn load-btn" id="loadDataBtn">Tải dữ liệu</button>
                    </div>
                </div>
            </div>
            
            <div class="table-section">
                <h3>Bảng chấm công tuần</h3>
                <div id="tableContainer">
                    <table id="attendanceTable">
                        <thead>
                            <tr id="tableHeader">
                                <!-- Header sẽ được tạo bằng JavaScript -->
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="action-buttons">
                    <button class="btn save-btn" id="saveBtn">Lưu chấm công</button>
                </div>
            </div>
        </div>

        <!-- Tab Chấm Tăng Ca -->
        <div id="overtime-tab" class="tab-content">
            <div class="filter-section">
                <h3>Lọc dữ liệu chấm tăng ca</h3>
                <div class="form-row">
                    <div class="form-field">
                        <label for="overtimeYearSelect">Năm</label>
                        <select id="overtimeYearSelect">
                            <option value="">-- Chọn năm --</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <label for="overtimeMonthSelect">Tháng</label>
                        <select id="overtimeMonthSelect">
                            <option value="">-- Chọn tháng --</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <label for="overtimeWeekSelect">Tuần</label>
                        <select id="overtimeWeekSelect">
                            <option value="">-- Chọn tuần --</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <label for="overtimeTeamSelect">Đội</label>
                        <select id="overtimeTeamSelect">
                            <option value="">-- Chọn đội --</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <button class="btn load-btn" id="loadOvertimeDataBtn">Tải dữ liệu</button>
                    </div>
                </div>
            </div>
            
            <div class="table-section">
                <h3>Bảng chấm tăng ca</h3>
                <div id="overtimeTableContainer">
                    <table id="overtimeTable">
                        <thead>
                            <tr id="overtimeTableHeader">
                                <!-- Header sẽ được tạo bằng JavaScript -->
                            </tr>
                        </thead>
                        <tbody id="overtimeTableBody">
                            <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="action-buttons">
                    <button class="btn save-btn" id="saveOvertimeBtn">Lưu tăng ca</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey : "AIzaSyDTOD66P7I9d9Nc-SeRySoCskl5EEquR-w" , 
            authDomain : "chamcong-9385e.firebaseapp.com" , 
            databaseURL : "https://chamcong-9385e-default-rtdb.asia-southeast1.firebasedatabase.app" , 
            projectId : "chamcong-9385e" , 
            storageBucket : "chamcong-9385e.firebasestorage.app" , 
            messagingSenderId : "416187735141" , 
            appId : "1:416187735141:web:e0a6010118ae5ce5b47a8c" 
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Biến toàn cục
        let currentUser = null;
        let teams = [];
        let employees = [];
        let currentWeekDays = [];
        let currentTab = 'weekly';
        
        // DOM Elements
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const weekSelect = document.getElementById('weekSelect');
        const teamSelect = document.getElementById('teamSelect');
        const loadDataBtn = document.getElementById('loadDataBtn');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const saveBtn = document.getElementById('saveBtn');
        
        // Overtime DOM Elements
        const overtimeYearSelect = document.getElementById('overtimeYearSelect');
        const overtimeMonthSelect = document.getElementById('overtimeMonthSelect');
        const overtimeWeekSelect = document.getElementById('overtimeWeekSelect');
        const overtimeTeamSelect = document.getElementById('overtimeTeamSelect');
        const loadOvertimeDataBtn = document.getElementById('loadOvertimeDataBtn');
        const overtimeTableHeader = document.getElementById('overtimeTableHeader');
        const overtimeTableBody = document.getElementById('overtimeTableBody');
        const saveOvertimeBtn = document.getElementById('saveOvertimeBtn');
        
        // Kiểm tra trạng thái đăng nhập
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                initializeForms();
                loadTeams();
            } else {
                window.location.href = 'index.html';
            }
        });
        
        // Hàm lấy đường dẫn cơ sở dữ liệu cho user hiện tại
        function getUserPath() {
            return `users/${currentUser.uid}`;
        }
        
        // Hàm khởi tạo form
        function initializeForms() {
            // Khởi tạo form chấm công tuần
            initializeForm(yearSelect, monthSelect, weekSelect);
            
            // Khởi tạo form chấm tăng ca
            initializeForm(overtimeYearSelect, overtimeMonthSelect, overtimeWeekSelect);
        }
        
        // Hàm khởi tạo form chung
        function initializeForm(yearElement, monthElement, weekElement) {
            // Tạo danh sách năm (từ 2020 đến 2030)
            const currentYear = new Date().getFullYear();
            for (let year = 2020; year <= 2030; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearElement.appendChild(option);
            }
            
            // Tạo danh sách tháng
            const months = [
                {value: 1, name: "Tháng 1"},
                {value: 2, name: "Tháng 2"},
                {value: 3, name: "Tháng 3"},
                {value: 4, name: "Tháng 4"},
                {value: 5, name: "Tháng 5"},
                {value: 6, name: "Tháng 6"},
                {value: 7, name: "Tháng 7"},
                {value: 8, name: "Tháng 8"},
                {value: 9, name: "Tháng 9"},
                {value: 10, name: "Tháng 10"},
                {value: 11, name: "Tháng 11"},
                {value: 12, name: "Tháng 12"}
            ];
            
            const currentMonth = new Date().getMonth() + 1;
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.name;
                if (month.value === currentMonth) {
                    option.selected = true;
                }
                monthElement.appendChild(option);
            });
            
            // Tạo danh sách tuần
            for (let week = 1; week <= 5; week++) {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = `Tuần ${week}`;
                weekElement.appendChild(option);
            }
            
            // Thêm sự kiện khi thay đổi tháng
            monthElement.addEventListener('change', () => updateWeeks(yearElement, monthElement, weekElement));
            yearElement.addEventListener('change', () => updateWeeks(yearElement, monthElement, weekElement));
        }
        
        // Hàm cập nhật số tuần dựa trên tháng và năm
        function updateWeeks(yearElement, monthElement, weekElement) {
            const year = parseInt(yearElement.value);
            const month = parseInt(monthElement.value);
            
            if (!year || !month) return;
            
            // Tính số tuần trong tháng
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            // Tính tuần đầu tiên và cuối cùng
            const firstWeek = Math.ceil((firstDay.getDate() + 6 - firstDay.getDay()) / 7);
            const lastWeek = Math.ceil((lastDay.getDate() + 6 - firstDay.getDay()) / 7);
            
            // Cập nhật danh sách tuần
            weekElement.innerHTML = '<option value="">-- Chọn tuần --</option>';
            for (let week = firstWeek; week <= lastWeek; week++) {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = `Tuần ${week}`;
                weekElement.appendChild(option);
            }
        }
        
        // Hàm tải danh sách đội
        function loadTeams() {
            const userPath = getUserPath();
            database.ref(`${userPath}/teams`).on('value', (snapshot) => {
                teams = [];
                teamSelect.innerHTML = '<option value="">-- Chọn đội --</option>';
                overtimeTeamSelect.innerHTML = '<option value="">-- Chọn đội --</option>';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const team = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        teams.push(team);
                        
                        // Thêm vào combobox chấm công tuần
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        teamSelect.appendChild(option);
                        
                        // Thêm vào combobox chấm tăng ca
                        const optionOvertime = document.createElement('option');
                        optionOvertime.value = team.id;
                        optionOvertime.textContent = team.name;
                        overtimeTeamSelect.appendChild(optionOvertime);
                    });
                }
            });
        }
        
        // Hàm tải nhân viên theo đội
        function loadEmployeesByTeam(teamId, isOvertime = false) {
            const userPath = getUserPath();
            database.ref(`${userPath}/employees`).once('value').then((snapshot) => {
                employees = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const employee = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        
                        if (employee.teamId === teamId) {
                            employees.push(employee);
                        }
                    });
                }
                
                if (isOvertime) {
                    generateOvertimeTable();
                } else {
                    generateAttendanceTable();
                }
            });
        }
        
        // Hàm tính các ngày trong tuần (từ Thứ 7 đến Thứ 6)
        function calculateWeekDays(year, month, week) {
            const days = [];
            
            // Tìm ngày Thứ 7 đầu tiên của tuần
            const firstDayOfMonth = new Date(year, month - 1, 1);
            const firstSaturday = new Date(firstDayOfMonth);
            
            // Tìm Thứ 7 đầu tiên của tháng
            const dayOfWeek = firstDayOfMonth.getDay(); // 0=CN, 1=T2, ..., 6=T7
            const daysToFirstSaturday = dayOfWeek === 6 ? 0 : 6 - dayOfWeek;
            firstSaturday.setDate(firstDayOfMonth.getDate() + daysToFirstSaturday);
            
            // Tính ngày bắt đầu của tuần được chọn
            const startDate = new Date(firstSaturday);
            startDate.setDate(firstSaturday.getDate() + (week - 1) * 7);
            
            // Tạo danh sách 7 ngày từ Thứ 7 đến Thứ 6
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                // Kiểm tra xem ngày có trong tháng đã chọn không
                if (currentDate.getMonth() + 1 !== month) {
                    continue;
                }
                
                const dayName = getDayName(currentDate.getDay());
                const formattedDate = formatDate(currentDate);
                
                days.push({
                    date: currentDate,
                    dayName: dayName,
                    formattedDate: formattedDate,
                    isWeekend: currentDate.getDay() === 0 || currentDate.getDay() === 6
                });
            }
            
            return days;
        }
        
        // Hàm lấy tên thứ
        function getDayName(dayIndex) {
            const days = ['Chủ Nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
            return days[dayIndex];
        }
        
        // Hàm định dạng ngày (dd/mm)
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${day}/${month}`;
        }
        
        // Hàm tạo bảng chấm công tuần
        function generateAttendanceTable() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            const week = parseInt(weekSelect.value);
            const teamId = teamSelect.value;
            
            if (!year || !month || !week || !teamId) {
                alert('Vui lòng chọn đầy đủ thông tin năm, tháng, tuần và đội');
                return;
            }
            
            // Tính các ngày trong tuần
            currentWeekDays = calculateWeekDays(year, month, week);
            
            // Tạo header cho bảng
            tableHeader.innerHTML = '<th class="employee-name">Tên nhân viên</th>';
            currentWeekDays.forEach(day => {
                const th = document.createElement('th');
                th.className = `day-header ${day.isWeekend ? 'weekend' : ''}`;
                th.innerHTML = `${day.dayName}<br>${day.formattedDate}`;
                tableHeader.appendChild(th);
            });
            
            // Tạo body cho bảng
            tableBody.innerHTML = '';
            employees.forEach(employee => {
                const row = document.createElement('tr');
                
                // Ô tên nhân viên
                const nameCell = document.createElement('td');
                nameCell.className = 'employee-name';
                nameCell.textContent = employee.name;
                row.appendChild(nameCell);
                
                // Ô chấm công cho từng ngày
                currentWeekDays.forEach(day => {
                    const cell = document.createElement('td');
                    if (day.isWeekend) {
                        cell.className = 'weekend';
                    }
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.max = '24';
                    input.step = '0.5';
                    input.value = '0';
                    input.dataset.date = day.date.toISOString().split('T')[0];
                    input.dataset.employeeId = employee.id;
                    
                    cell.appendChild(input);
                    row.appendChild(cell);
                });
                
                tableBody.appendChild(row);
            });
            
            // Tải dữ liệu đã lưu
            setTimeout(() => loadSavedAttendance('attendance'), 100);
        }
        
        // Hàm tạo bảng chấm tăng ca
        function generateOvertimeTable() {
            const year = parseInt(overtimeYearSelect.value);
            const month = parseInt(overtimeMonthSelect.value);
            const week = parseInt(overtimeWeekSelect.value);
            const teamId = overtimeTeamSelect.value;
            
            if (!year || !month || !week || !teamId) {
                alert('Vui lòng chọn đầy đủ thông tin năm, tháng, tuần và đội');
                return;
            }
            
            // Tính các ngày trong tuần
            currentWeekDays = calculateWeekDays(year, month, week);
            
            // Tạo header cho bảng
            overtimeTableHeader.innerHTML = '<th class="employee-name">Tên nhân viên</th>';
            currentWeekDays.forEach(day => {
                const th = document.createElement('th');
                th.className = `day-header ${day.isWeekend ? 'weekend' : ''}`;
                th.innerHTML = `${day.dayName}<br>${day.formattedDate}`;
                overtimeTableHeader.appendChild(th);
            });
            
            // Tạo body cho bảng
            overtimeTableBody.innerHTML = '';
            employees.forEach(employee => {
                const row = document.createElement('tr');
                
                // Ô tên nhân viên
                const nameCell = document.createElement('td');
                nameCell.className = 'employee-name';
                nameCell.textContent = employee.name;
                row.appendChild(nameCell);
                
                // Ô chấm tăng ca cho từng ngày
                currentWeekDays.forEach(day => {
                    const cell = document.createElement('td');
                    if (day.isWeekend) {
                        cell.className = 'weekend';
                    }
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.max = '24';
                    input.step = '0.5';
                    input.value = '0';
                    input.dataset.date = day.date.toISOString().split('T')[0];
                    input.dataset.employeeId = employee.id;
                    
                    cell.appendChild(input);
                    row.appendChild(cell);
                });
                
                overtimeTableBody.appendChild(row);
            });
            
            // Tải dữ liệu đã lưu
            setTimeout(() => loadSavedAttendance('overtime'), 100);
        }
        
        // Hàm lưu chấm công - ĐÃ SỬA LỖI
        function saveAttendance(type = 'attendance') {
            let year, month, week, teamId, inputs, saveMessage;
            
            if (type === 'attendance') {
                year = parseInt(yearSelect.value);
                month = parseInt(monthSelect.value);
                week = parseInt(weekSelect.value);
                teamId = teamSelect.value;
                inputs = document.querySelectorAll('#tableBody input[type="number"]');
                saveMessage = 'chấm công';
            } else {
                year = parseInt(overtimeYearSelect.value);
                month = parseInt(overtimeMonthSelect.value);
                week = parseInt(overtimeWeekSelect.value);
                teamId = overtimeTeamSelect.value;
                inputs = document.querySelectorAll('#overtimeTableBody input[type="number"]');
                saveMessage = 'tăng ca';
            }
            
            if (!year || !month || !week || !teamId) {
                alert(`Vui lòng chọn đầy đủ thông tin năm, tháng, tuần và đội`);
                return;
            }
            
            if (employees.length === 0) {
                alert(`Không có nhân viên nào để lưu ${saveMessage}`);
                return;
            }
            
            // Thu thập dữ liệu
            const attendanceData = {};
            
            inputs.forEach(input => {
                const employeeId = input.dataset.employeeId;
                const date = input.dataset.date;
                const hours = parseFloat(input.value) || 0;
                
                if (!attendanceData[employeeId]) {
                    attendanceData[employeeId] = {};
                }
                
                attendanceData[employeeId][date] = hours;
            });
            
            // Lưu vào Firebase
            const userPath = getUserPath();
            const refPath = type === 'attendance' ? 'attendance' : 'overtime';
            const attendanceRef = database.ref(`${userPath}/${refPath}/${year}/${month}/week_${week}/${teamId}`);
            
            attendanceRef.set(attendanceData)
                .then(() => {
                    alert(`Lưu ${saveMessage} thành công!`);
                })
                .catch((error) => {
                    console.error(`Lỗi khi lưu ${saveMessage}:`, error);
                    alert(`Có lỗi xảy ra khi lưu ${saveMessage}`);
                });
        }
        
        // Hàm tải dữ liệu chấm công đã lưu
        function loadSavedAttendance(type = 'attendance') {
            let year, month, week, teamId, inputs;
            
            if (type === 'attendance') {
                year = parseInt(yearSelect.value);
                month = parseInt(monthSelect.value);
                week = parseInt(weekSelect.value);
                teamId = teamSelect.value;
                inputs = document.querySelectorAll('#tableBody input[type="number"]');
            } else {
                year = parseInt(overtimeYearSelect.value);
                month = parseInt(overtimeMonthSelect.value);
                week = parseInt(overtimeWeekSelect.value);
                teamId = overtimeTeamSelect.value;
                inputs = document.querySelectorAll('#overtimeTableBody input[type="number"]');
            }
            
            if (!year || !month || !week || !teamId) {
                return;
            }
            
            const userPath = getUserPath();
            const refPath = type === 'attendance' ? 'attendance' : 'overtime';
            const attendanceRef = database.ref(`${userPath}/${refPath}/${year}/${month}/week_${week}/${teamId}`);
            
            attendanceRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const savedData = snapshot.val();
                    
                    // Cập nhật giá trị vào các input
                    inputs.forEach(input => {
                        const employeeId = input.dataset.employeeId;
                        const date = input.dataset.date;
                        
                        if (savedData[employeeId] && savedData[employeeId][date] !== undefined) {
                            input.value = savedData[employeeId][date];
                        }
                    });
                }
            });
        }
        
        // Event Listeners cho tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Ẩn tất cả tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Bỏ active tất cả tabs
                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                });
                
                // Hiển thị tab content được chọn
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
                tab.classList.add('active');
                currentTab = tabId;
            });
        });
        
        // Event Listeners cho chấm công tuần
        loadDataBtn.addEventListener('click', () => {
            const teamId = teamSelect.value;
            if (teamId) {
                loadEmployeesByTeam(teamId, false);
            } else {
                alert('Vui lòng chọn đội');
            }
        });
        
        saveBtn.addEventListener('click', () => saveAttendance('attendance'));
        
        // Event Listeners cho chấm tăng ca
        loadOvertimeDataBtn.addEventListener('click', () => {
            const teamId = overtimeTeamSelect.value;
            if (teamId) {
                loadEmployeesByTeam(teamId, true);
            } else {
                alert('Vui lòng chọn đội');
            }
        });
        
        saveOvertimeBtn.addEventListener('click', () => saveAttendance('overtime'));
    </script>
</body>
</html>