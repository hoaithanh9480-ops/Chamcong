<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tổng Hợp Chấm Công</title>
    <style>
        /* CSS giữ nguyên như trước */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .fixed-header {
            background-color: #34495e;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            height: 60px;
        }

        .fixed-header h2 {
            font-size: 1.3rem;
            font-weight: normal;
        }

        .fixed-header .back-btn {
            background-color: transparent;
            border: 1px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .fixed-header .back-btn:hover {
            background-color: #3498db;
            border-color: #3498db;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 60px;
        }

        .filter-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: end;
        }

        .form-field {
            flex: 1;
            min-width: 150px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .export-btn {
            background-color: #2ecc71;
            color: white;
        }

        .export-btn:hover {
            background-color: #27ae60;
        }

        .table-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th, td {
            padding: 10px 12px;
            text-align: center;
            border: 1px solid #ddd;
            white-space: nowrap;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        .employee-name {
            text-align: left;
            font-weight: 500;
            background-color: #f1f8ff;
            position: sticky;
            left: 0;
            z-index: 1;
        }

        .stt-column {
            background-color: #f1f8ff;
            position: sticky;
            left: 0;
            z-index: 1;
        }

        .salary-column {
            background-color: #fff9e6;
        }

        .total-column {
            background-color: #e8f5e8;
            font-weight: 600;
        }

        .day-column {
            background-color: #f0f8ff;
            min-width: 80px;
        }

        .weekend {
            background-color: #fff0f0;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .summary-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .summary-item {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .auto-load-notice {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 8px 12px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #1976d2;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .fixed-header {
                padding: 8px 15px;
                height: 50px;
            }
            
            .fixed-header h2 {
                font-size: 1rem;
            }
            
            .fixed-header .back-btn {
                padding: 4px 8px;
                font-size: 0.85rem;
            }
            
            .container {
                padding: 10px;
                margin-top: 50px;
            }
            
            .filter-section, .table-section, .summary-section {
                padding: 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-field {
                min-width: 100%;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 0.85rem;
            }
            
            .action-buttons {
                position: sticky;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                padding: 15px;
                margin: 20px -15px -15px -15px;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                z-index: 100;
            }

            .table-section {
                padding-bottom: 80px;
            }
        }

        @media (max-width: 480px) {
            .fixed-header {
                padding: 6px 10px;
                height: 45px;
            }
            
            .fixed-header h2 {
                font-size: 0.9rem;
            }
            
            .container {
                padding: 8px;
                margin-top: 45px;
            }
            
            .filter-section, .table-section, .summary-section {
                padding: 12px;
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 0.8rem;
            }
        }
    </style>
    <!-- Thêm thư viện SheetJS để xuất Excel chuẩn -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

</head>
<body>
    <header class="fixed-header">
        <h2>Tổng Hợp Chấm Công</h2>
        <div>
            <button class="back-btn" onclick="window.location.href='dashboard.html'">Quay lại</button>
        </div>
    </header>

    <div class="container">
        <div class="filter-section">
            <h3>Lọc dữ liệu tổng hợp</h3>
            <div class="form-row">
                <div class="form-field">
                    <label for="yearSelect">Năm</label>
                    <select id="yearSelect">
                        <option value="">-- Chọn năm --</option>
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="monthSelect">Tháng</label>
                    <select id="monthSelect">
                        <option value="">-- Chọn tháng --</option>
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="weekSelect">Tuần</label>
                    <select id="weekSelect">
                        <option value="">-- Chọn tuần --</option>
                        <option value="all">Tất cả tuần</option>
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="teamSelect">Đội</label>
                    <select id="teamSelect">
                        <option value="">-- Chọn đội --</option>
                        <option value="all">Tất cả đội</option>
                    </select>
                </div>
            </div>
            <div class="auto-load-notice">
                ⚡ Dữ liệu sẽ tự động tải khi bạn chọn đầy đủ thông tin
            </div>
        </div>
        
        <div class="table-section">
            <h3>Bảng tổng hợp chấm công</h3>
            <div id="tableContainer">
                <table id="summaryTable">
                    <thead>
                        <tr id="tableHeader">
                            <!-- Header sẽ được tạo bằng JavaScript -->
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="20" class="loading" id="loadingMessage">
                                Vui lòng chọn năm, tháng, tuần và đội để xem dữ liệu
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="action-buttons">
                <button class="btn export-btn" id="exportBtn">Xuất Excel</button>
            </div>
        </div>

        <div class="summary-section">
            <h3>Tổng kết</h3>
            <div class="summary-row">
                <div class="summary-item">
                    <div>Tổng công tuần</div>
                    <div class="summary-value" id="totalWorkHours">0</div>
                </div>
                <div class="summary-item">
                    <div>Tổng tăng ca</div>
                    <div class="summary-value" id="totalOvertimeHours">0</div>
                </div>
                <div class="summary-item">
                    <div>Tổng lương tuần</div>
                    <div class="summary-value" id="totalWeeklySalary">0</div>
                </div>
                <div class="summary-item">
                    <div>Tổng lương tăng ca</div>
                    <div class="summary-value" id="totalOvertimeSalary">0</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey : "AIzaSyDTOD66P7I9d9Nc-SeRySoCskl5EEquR-w" , 
            authDomain : "chamcong-9385e.firebaseapp.com" , 
            databaseURL : "https://chamcong-9385e-default-rtdb.asia-southeast1.firebasedatabase.app" , 
            projectId : "chamcong-9385e" , 
            storageBucket : "chamcong-9385e.firebasestorage.app" , 
            messagingSenderId : "416187735141" , 
            appId : "1:416187735141:web:e0a6010118ae5ce5b47a8c" 
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Biến toàn cục
        let currentUser = null;
        let teams = [];
        let allEmployees = [];
        let allWeekDays = [];
        let attendanceData = {};
        let overtimeData = {};
        let isLoading = false;
        
        // DOM Elements
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const weekSelect = document.getElementById('weekSelect');
        const teamSelect = document.getElementById('teamSelect');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const exportBtn = document.getElementById('exportBtn');
        const totalWorkHours = document.getElementById('totalWorkHours');
        const totalOvertimeHours = document.getElementById('totalOvertimeHours');
        const totalWeeklySalary = document.getElementById('totalWeeklySalary');
        const totalOvertimeSalary = document.getElementById('totalOvertimeSalary');
        const loadingMessage = document.getElementById('loadingMessage');
        
        // Kiểm tra trạng thái đăng nhập
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                initializeForm();
                loadTeams();
                loadAllEmployees();
            } else {
                window.location.href = 'index.html';
            }
        });
        
        // Hàm lấy đường dẫn cơ sở dữ liệu cho user hiện tại
        function getUserPath() {
            return `users/${currentUser.uid}`;
        }
        
        // Hàm khởi tạo form
        function initializeForm() {
            // Tạo danh sách năm (từ 2020 đến 2030)
            const currentYear = new Date().getFullYear();
            for (let year = 2020; year <= 2030; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            
            // Tạo danh sách tháng
            const months = [
                {value: 1, name: "Tháng 1"},
                {value: 2, name: "Tháng 2"},
                {value: 3, name: "Tháng 3"},
                {value: 4, name: "Tháng 4"},
                {value: 5, name: "Tháng 5"},
                {value: 6, name: "Tháng 6"},
                {value: 7, name: "Tháng 7"},
                {value: 8, name: "Tháng 8"},
                {value: 9, name: "Tháng 9"},
                {value: 10, name: "Tháng 10"},
                {value: 11, name: "Tháng 11"},
                {value: 12, name: "Tháng 12"}
            ];
            
            const currentMonth = new Date().getMonth() + 1;
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.name;
                if (month.value === currentMonth) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            });
            
            // Thêm sự kiện khi thay đổi
            yearSelect.addEventListener('change', function() {
                updateWeeks();
                autoLoadData();
            });
            monthSelect.addEventListener('change', function() {
                updateWeeks();
                autoLoadData();
            });
            weekSelect.addEventListener('change', autoLoadData);
            teamSelect.addEventListener('change', autoLoadData);
            updateWeeks();
        }
        
        // Hàm tự động load dữ liệu khi chọn đủ thông tin
        function autoLoadData() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            const week = weekSelect.value;
            const teamId = teamSelect.value;
            
            if (year && month && week && teamId) {
                loadData();
            } else {
                // Hiển thị thông báo hướng dẫn
                loadingMessage.textContent = 'Vui lòng chọn năm, tháng, tuần và đội để xem dữ liệu';
                loadingMessage.style.display = 'table-cell';
                tableBody.innerHTML = '<tr><td colspan="20" class="loading" id="loadingMessage">Vui lòng chọn năm, tháng, tuần và đội để xem dữ liệu</td></tr>';
                
                // Reset tổng kết
                updateSummary(0, 0, 0, 0);
            }
        }
        
        // Hàm cập nhật số tuần dựa trên tháng và năm
        function updateWeeks() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            
            if (!year || !month) return;
            
            // Tính số tuần trong tháng
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            // Tính tuần đầu tiên và cuối cùng
            const firstWeek = Math.ceil((firstDay.getDate() + 6 - firstDay.getDay()) / 7);
            const lastWeek = Math.ceil((lastDay.getDate() + 6 - firstDay.getDay()) / 7);
            
            // Cập nhật danh sách tuần
            weekSelect.innerHTML = '<option value="">-- Chọn tuần --</option><option value="all">Tất cả tuần</option>';
            for (let week = firstWeek; week <= lastWeek; week++) {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = `Tuần ${week}`;
                weekSelect.appendChild(option);
            }
        }
        
        // Hàm tải danh sách đội
        function loadTeams() {
            const userPath = getUserPath();
            database.ref(`${userPath}/teams`).on('value', (snapshot) => {
                teams = [];
                teamSelect.innerHTML = '<option value="">-- Chọn đội --</option><option value="all">Tất cả đội</option>';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const team = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        teams.push(team);
                        
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        teamSelect.appendChild(option);
                    });
                }
            });
        }
        
        // Hàm tải tất cả nhân viên
        function loadAllEmployees() {
            const userPath = getUserPath();
            database.ref(`${userPath}/employees`).on('value', (snapshot) => {
                allEmployees = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const employee = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        allEmployees.push(employee);
                    });
                }
                
                // Tự động load dữ liệu nếu đã có đủ thông tin
                autoLoadData();
            });
        }
        
        // Hàm tải dữ liệu và tính toán
        function loadData() {
            if (isLoading) return;
            
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            const week = weekSelect.value;
            const teamId = teamSelect.value;
            
            if (!year || !month || !week || !teamId) {
                return;
            }
            
            isLoading = true;
            loadingMessage.textContent = 'Đang tải dữ liệu...';
            loadingMessage.style.display = 'table-cell';
            
            // Lọc nhân viên theo đội
            const filteredEmployees = teamId === 'all' 
                ? allEmployees 
                : allEmployees.filter(emp => emp.teamId === teamId);
            
            if (filteredEmployees.length === 0) {
                loadingMessage.textContent = 'Không có nhân viên nào trong đội được chọn';
                isLoading = false;
                return;
            }
            
            const userPath = getUserPath();
            
            if (week === 'all') {
                // Tải tất cả các tuần trong tháng
                loadAllWeeksData(year, month, teamId, filteredEmployees);
            } else {
                // Tải dữ liệu cho tuần cụ thể
                loadSingleWeekData(year, month, parseInt(week), teamId, filteredEmployees);
            }
        }
        
        // Hàm tải dữ liệu cho một tuần cụ thể
        function loadSingleWeekData(year, month, week, teamId, employees) {
            // Tính các ngày trong tuần
            allWeekDays = calculateWeekDays(year, month, week);
            
            const userPath = getUserPath();
            
            // Tải dữ liệu chấm công và tăng ca
            const attendanceRef = database.ref(`${userPath}/attendance/${year}/${month}/week_${week}`);
            const overtimeRef = database.ref(`${userPath}/overtime/${year}/${month}/week_${week}`);
            
            Promise.all([
                attendanceRef.once('value'),
                overtimeRef.once('value')
            ]).then(([attendanceSnapshot, overtimeSnapshot]) => {
                attendanceData = attendanceSnapshot.exists() ? attendanceSnapshot.val() : {};
                overtimeData = overtimeSnapshot.exists() ? overtimeSnapshot.val() : {};
                
                generateSummaryTable(employees);
                isLoading = false;
            }).catch(error => {
                console.error('Lỗi khi tải dữ liệu:', error);
                loadingMessage.textContent = 'Có lỗi xảy ra khi tải dữ liệu';
                isLoading = false;
            });
        }
        
        // Hàm tải dữ liệu cho tất cả các tuần trong tháng
        function loadAllWeeksData(year, month, teamId, employees) {
            const userPath = getUserPath();
            
            // Tính tất cả các tuần trong tháng
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const firstWeek = Math.ceil((firstDay.getDate() + 6 - firstDay.getDay()) / 7);
            const lastWeek = Math.ceil((lastDay.getDate() + 6 - firstDay.getDay()) / 7);
            
            // Tạo danh sách tất cả các ngày trong tháng
            allWeekDays = [];
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDate = new Date(year, month - 1, day);
                const dayName = getDayName(currentDate.getDay());
                const formattedDate = formatDate(currentDate);
                
                allWeekDays.push({
                    date: currentDate,
                    dayName: dayName,
                    formattedDate: formattedDate,
                    dateString: currentDate.toISOString().split('T')[0],
                    isWeekend: currentDate.getDay() === 0 || currentDate.getDay() === 6
                });
            }
            
            // Tải dữ liệu cho tất cả các tuần
            const promises = [];
            const allAttendanceData = {};
            const allOvertimeData = {};
            
            for (let week = firstWeek; week <= lastWeek; week++) {
                promises.push(
                    database.ref(`${userPath}/attendance/${year}/${month}/week_${week}`).once('value'),
                    database.ref(`${userPath}/overtime/${year}/${month}/week_${week}`).once('value')
                );
            }
            
            Promise.all(promises).then(results => {
                // Xử lý dữ liệu từ tất cả các tuần
                for (let i = 0; i < results.length; i += 2) {
                    const attendanceSnapshot = results[i];
                    const overtimeSnapshot = results[i + 1];
                    
                    if (attendanceSnapshot.exists()) {
                        const weekData = attendanceSnapshot.val();
                        Object.assign(allAttendanceData, weekData);
                    }
                    
                    if (overtimeSnapshot.exists()) {
                        const weekData = overtimeSnapshot.val();
                        Object.assign(allOvertimeData, weekData);
                    }
                }
                
                attendanceData = allAttendanceData;
                overtimeData = allOvertimeData;
                
                generateSummaryTable(employees);
                isLoading = false;
            }).catch(error => {
                console.error('Lỗi khi tải dữ liệu:', error);
                loadingMessage.textContent = 'Có lỗi xảy ra khi tải dữ liệu';
                isLoading = false;
            });
        }
        
        // Hàm tính các ngày trong tuần (từ Thứ 7 đến Thứ 6)
        function calculateWeekDays(year, month, week) {
            const days = [];
            
            // Tìm ngày Thứ 7 đầu tiên của tuần
            const firstDayOfMonth = new Date(year, month - 1, 1);
            const firstSaturday = new Date(firstDayOfMonth);
            
            // Tìm Thứ 7 đầu tiên của tháng
            const dayOfWeek = firstDayOfMonth.getDay(); // 0=CN, 1=T2, ..., 6=T7
            const daysToFirstSaturday = dayOfWeek === 6 ? 0 : 6 - dayOfWeek;
            firstSaturday.setDate(firstDayOfMonth.getDate() + daysToFirstSaturday);
            
            // Tính ngày bắt đầu của tuần được chọn
            const startDate = new Date(firstSaturday);
            startDate.setDate(firstSaturday.getDate() + (week - 1) * 7);
            
            // Tạo danh sách 7 ngày từ Thứ 7 đến Thứ 6
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                // Kiểm tra xem ngày có trong tháng đã chọn không
                if (currentDate.getMonth() + 1 !== month) {
                    continue;
                }
                
                const dayName = getDayName(currentDate.getDay());
                const formattedDate = formatDate(currentDate);
                
                days.push({
                    date: currentDate,
                    dayName: dayName,
                    formattedDate: formattedDate,
                    dateString: currentDate.toISOString().split('T')[0],
                    isWeekend: currentDate.getDay() === 0 || currentDate.getDay() === 6
                });
            }
            
            return days;
        }
        
        // Hàm lấy tên thứ
        function getDayName(dayIndex) {
            const days = ['Chủ Nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
            return days[dayIndex];
        }
        
        // Hàm định dạng ngày (dd/mm)
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${day}/${month}`;
        }
        
        // Hàm định dạng ngày tháng để hiển thị (dd/mm/yyyy)
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Hàm định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        // Hàm tính tổng số giờ công từ dữ liệu chấm công
        function calculateTotalHours(employeeId, teamId, data) {
    let totalHours = 0;
    
    // Duyệt qua tất cả các đội (nếu chọn "Tất cả đội")
    const teamsToCheck = teamId === 'all' ? Object.keys(data) : [teamId];
    
    teamsToCheck.forEach(currentTeamId => {
        if (data[currentTeamId] && data[currentTeamId][employeeId]) {
            Object.values(data[currentTeamId][employeeId]).forEach(hours => {
                // Sử dụng hàm cộng chính xác để tránh làm tròn
                totalHours = preciseAdd(totalHours, parseFloat(hours) || 0);
            });
        }
    });
    
    return totalHours;
}
        
        // Hàm lấy số giờ làm việc theo ngày
        function getHoursByDate(employeeId, teamId, dateString, data) {
    let totalHours = 0;
    
    // Duyệt qua tất cả các đội (nếu chọn "Tất cả đội")
    const teamsToCheck = teamId === 'all' ? Object.keys(data) : [teamId];
    
    teamsToCheck.forEach(currentTeamId => {
        if (data[currentTeamId] && data[currentTeamId][employeeId] && data[currentTeamId][employeeId][dateString]) {
            // Sử dụng hàm cộng chính xác
            totalHours = preciseAdd(totalHours, parseFloat(data[currentTeamId][employeeId][dateString]) || 0);
        }
    });
    
    return totalHours;
}

// Hàm cộng số thập phân chính xác
function preciseAdd(a, b) {
    const precision = 100; // Độ chính xác 2 chữ số thập phân
    return (Math.round(a * precision) + Math.round(b * precision)) / precision;
}

// Hàm nhân số thập phân chính xác
function preciseMultiply(a, b) {
    const precision = 10000; // Độ chính xác cao cho phép nhân
    return (Math.round(a * precision) * Math.round(b * precision)) / (precision * precision);
}
        
        // Hàm tạo bảng tổng hợp
        function generateSummaryTable(employees) {
    // Ẩn thông báo loading
    loadingMessage.style.display = 'none';
    
    if (employees.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="20" class="no-data">Không có dữ liệu để hiển thị</td></tr>';
        updateSummary(0, 0, 0, 0);
        return;
    }
    
    // Tạo header cho bảng
    tableHeader.innerHTML = `
        <th class="stt-column">STT</th>
        <th class="employee-name">Họ và tên</th>
        <th>Năm sinh</th>
        <th>Số CCCD</th>
        <th>Chức vụ</th>
        <th class="salary-column">Lương ngày</th>
        <th class="salary-column">Lương tăng ca</th>
        <th>Tên Đội</th>
        <th class="salary-column">Công tuần</th>
        <th class="salary-column">Công tăng ca</th>
        <th class="salary-column">Lương ngày</th>
        <th class="salary-column">Lương tăng ca</th>
    `;
    
    // Thêm các cột ngày
    allWeekDays.forEach(day => {
        const th = document.createElement('th');
        th.className = `day-column ${day.isWeekend ? 'weekend' : ''}`;
        th.innerHTML = `${day.dayName}<br>${day.formattedDate}`;
        th.title = `${day.dateString}`;
        tableHeader.appendChild(th);
    });
    
    // Tạo body cho bảng
    tableBody.innerHTML = '';
    
    let totalWork = 0;
    let totalOvertime = 0;
    let totalWeekly = 0;
    let totalOvertimeSal = 0;
    
    employees.forEach((employee, index) => {
        const teamId = employee.teamId;
        const teamName = teams.find(t => t.id === teamId)?.name || 'Không xác định';
        
        // Tính toán các giá trị với độ chính xác cao
        const workHours = calculateTotalHours(employee.id, teamSelect.value, attendanceData);
        const overtimeHours = calculateTotalHours(employee.id, teamSelect.value, overtimeData);
        const dailySalary = parseFloat(employee.dailySalary) || 0;
        const overtimeRate = parseFloat(employee.overtimeSalary) || 0;
        
        // Sử dụng hàm nhân chính xác để tính lương
        const weeklySalary = preciseMultiply(workHours, dailySalary);
        const overtimeSalary = preciseMultiply(overtimeHours, overtimeRate);
        
        // Cộng dồn vào tổng với độ chính xác
        totalWork = preciseAdd(totalWork, workHours);
        totalOvertime = preciseAdd(totalOvertime, overtimeHours);
        totalWeekly = preciseAdd(totalWeekly, weeklySalary);
        totalOvertimeSal = preciseAdd(totalOvertimeSal, overtimeSalary);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="stt-column">${index + 1}</td>
            <td class="employee-name">${employee.name}</td>
            <td>${formatDateForDisplay(employee.birthDate)}</td>
            <td>${employee.idNumber}</td>
            <td>${employee.position}</td>
            <td class="salary-column">${formatCurrency(dailySalary)}</td>
            <td class="salary-column">${formatCurrency(overtimeRate)}</td>
            <td>${teamName}</td>
            <td class="salary-column">${workHours.toFixed(2)}</td> <!-- Hiển thị 2 chữ số thập phân -->
            <td class="salary-column">${overtimeHours.toFixed(2)}</td> <!-- Hiển thị 2 chữ số thập phân -->
            <td class="salary-column">${formatCurrency(weeklySalary)}</td>
            <td class="salary-column">${formatCurrency(overtimeSalary)}</td>
        `;
        
        // Thêm dữ liệu từng ngày
        allWeekDays.forEach(day => {
            const workHour = getHoursByDate(employee.id, teamSelect.value, day.dateString, attendanceData);
            const overtimeHour = getHoursByDate(employee.id, teamSelect.value, day.dateString, overtimeData);
            
            const cell = document.createElement('td');
            cell.className = day.isWeekend ? 'weekend' : '';
            
            if (workHour > 0 || overtimeHour > 0) {
                cell.innerHTML = `
                    <div style="font-size: 0.8rem;">
                        <div>C: ${workHour.toFixed(2)}</div> <!-- Hiển thị 2 chữ số thập phân -->
                        <div>TC: ${overtimeHour.toFixed(2)}</div> <!-- Hiển thị 2 chữ số thập phân -->
                    </div>
                `;
            } else {
                cell.innerHTML = '-';
            }
            row.appendChild(cell);
        });
        
        tableBody.appendChild(row);
    });
    
    // Cập nhật tổng kết
    updateSummary(totalWork, totalOvertime, totalWeekly, totalOvertimeSal);
}
        
        // Hàm cập nhật tổng kết
        function updateSummary(work, overtime, weekly, overtimeSal) {
    totalWorkHours.textContent = work.toFixed(2); // Hiển thị 2 chữ số thập phân
    totalOvertimeHours.textContent = overtime.toFixed(2); // Hiển thị 2 chữ số thập phân
    totalWeeklySalary.textContent = formatCurrency(weekly);
    totalOvertimeSalary.textContent = formatCurrency(overtimeSal);
}
        
        // Hàm xuất Excel với định dạng đẹp - ĐÃ THÊM KẺ KHUNG, CANH GIỮA VÀ IN ĐẬM
        function exportToExcel() {
    // --- HÀM HỖ TRỢ ---
    function getCleanNumber(text) {
        if (!text) return 0;
        const cleanString = text.replace(/[^\d]/g, '');
        return parseFloat(cleanString) || 0;
    }

    // --- TẠO WORKBOOK ---
    const wb = XLSX.utils.book_new();
    const excelData = [];

    // --- DÒNG 1: TIÊU ĐỀ CHÍNH ---
    const weekValue = weekSelect.value;
    const title = weekValue === 'all'
        ? `TỔNG HỢP CHẤM CÔNG - THÁNG ${monthSelect.value} NĂM ${yearSelect.value}`
        : `TỔNG HỢP CHẤM CÔNG - TUẦN ${weekValue} THÁNG ${monthSelect.value} NĂM ${yearSelect.value}`;
    excelData.push([title]);
    excelData.push([]); // dòng trống

    // --- TIÊU ĐỀ CỐ ĐỊNH ---
    const fixedHeaders = [
        'STT', 'Họ và tên', 'Năm sinh', 'Số CCCD', 'Chức vụ',
        'Lương ngày', 'Lương tăng ca', 'Tên Đội',
        'Công tuần', 'Công tăng ca', 'Lương ngày', 'Lương tăng ca'
    ];

    const headerRow1 = [...fixedHeaders];
    allWeekDays.forEach(day => headerRow1.push(day.formattedDate));
    excelData.push(headerRow1);

    const headerRow2 = Array(fixedHeaders.length).fill('');
    allWeekDays.forEach(day => headerRow2.push(day.dayName));
    excelData.push(headerRow2);

    // --- DỮ LIỆU NHÂN VIÊN ---
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach((row, index) => {
        const cells = row.cells;
        const rowData = [
            index + 1,
            cells[1].textContent,
            cells[2].textContent,
            cells[3].textContent,
            cells[4].textContent,
            getCleanNumber(cells[5].textContent),
            getCleanNumber(cells[6].textContent),
            cells[7].textContent,
            parseFloat(cells[8].textContent || 0),
            parseFloat(cells[9].textContent || 0),
            getCleanNumber(cells[10].textContent),
            getCleanNumber(cells[11].textContent)
        ];

        for (let i = 12; i < cells.length; i++) {
            const cellText = cells[i].textContent.trim();
            if (cellText === '-') {
                rowData.push('');
            } else {
                const lines = cellText.split('\n');
                const workHour = (lines[0].replace('C: ', '') || '0').trim();
                const overtimeHour = (lines[1].replace('TC: ', '') || '0').trim();
                rowData.push(`C:${workHour}\nTC:${overtimeHour}`);
            }
        }
        excelData.push(rowData);
    });

    // --- TẠO SHEET ---
    const ws = XLSX.utils.aoa_to_sheet(excelData);

    // --- STYLE ---
    const borderStyle = {
        top: { style: 'thin', color: { rgb: '000000' } },
        left: { style: 'thin', color: { rgb: '000000' } },
        bottom: { style: 'thin', color: { rgb: '000000' } },
        right: { style: 'thin', color: { rgb: '000000' } }
    };

    const totalCols = fixedHeaders.length + allWeekDays.length;
    const range = XLSX.utils.decode_range(ws['!ref']);

    const moneyCols = [5, 6, 10, 11];
    const workCols = [8, 9];

    // Áp style cho từng ô
    for (let R = range.s.r; R <= range.e.r; R++) {
        for (let C = range.s.c; C < totalCols; C++) {
            const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
            const cellData = excelData[R] ? excelData[R][C] : '';
            if (!ws[cell_ref]) ws[cell_ref] = { t: 's', v: cellData };

            ws[cell_ref].s = {
                alignment: {
                    horizontal: 'center',
                    vertical: 'center',
                    wrapText: true
                },
                border: borderStyle
            };

            // Dòng tiêu đề chính
            if (R === 0) {
                ws[cell_ref].s.font = { bold: true, sz: 16 };
                ws[cell_ref].s.alignment = { horizontal: 'center', vertical: 'center' };
                ws[cell_ref].s.border = undefined;
            }

            // Dòng tiêu đề bảng (3-4)
            if (R === 2 || R === 3) {
                ws[cell_ref].s.font = { bold: true };
                ws[cell_ref].s.fill = {
                    patternType: 'solid',
                    fgColor: { rgb: 'E6E6FA' }
                };
            }

            // Dòng trống giữa tiêu đề và bảng
            if (R === 1) {
                ws[cell_ref].s.border = undefined;
            }

            // Dòng dữ liệu
            if (R >= 4) {
                if (typeof cellData === 'number') ws[cell_ref].t = 'n';
                if (moneyCols.includes(C)) {
                    ws[cell_ref].z = '#,##0';
                    ws[cell_ref].s.alignment.horizontal = 'right';
                } else if (workCols.includes(C)) {
                    ws[cell_ref].z = '0';
                    ws[cell_ref].s.alignment.horizontal = 'center';
                }
            }
        }
    }

    // --- MERGE ---
    if (!ws['!merges']) ws['!merges'] = [];
    ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: totalCols - 1 } });

    for (let i = 0; i < fixedHeaders.length; i++) {
        ws['!merges'].push({ s: { r: 2, c: i }, e: { r: 3, c: i } });
    }

    // --- ĐỘ RỘNG CỘT ---
    const colWidths = [
        { wch: 5 }, { wch: 20 }, { wch: 10 }, { wch: 15 },
        { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 15 },
        { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 12 }
    ];
    allWeekDays.forEach(() => colWidths.push({ wch: 12 }));
    ws['!cols'] = colWidths;

    // --- AUTO ROW HEIGHT ---
    ws['!rows'] = excelData.map(row => ({
        hpt: 20 + (row.some(cell => (cell + '').includes('\n')) ? 10 : 0)
    }));

    // --- GHI FILE ---
    XLSX.utils.book_append_sheet(wb, ws, 'TongHopChamCong');
    const fileName = weekValue === 'all'
        ? `TONG_HOP_CHAM_CONG_${yearSelect.value}_${monthSelect.value}_TAT_CA_TUAN.xlsx`
        : `TONG_HOP_CHAM_CONG_${yearSelect.value}_${monthSelect.value}_TUAN_${weekValue}.xlsx`;

    XLSX.writeFile(wb, fileName, { compression: true });
}

        
        // Event Listeners
        exportBtn.addEventListener('click', exportToExcel);
        
        // Tự động load dữ liệu khi trang được tải
        setTimeout(() => {
            autoLoadData();
        }, 1000);
    </script>
</body>
</html>
