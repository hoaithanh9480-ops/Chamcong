<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đội - Tổng Hợp Lương</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* Thanh header cố định */
        .fixed-header {
            background-color: #34495e;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            height: 60px;
        }

        .fixed-header h2 {
            font-size: 1.3rem;
            font-weight: normal;
        }

        .fixed-header .back-btn {
            background-color: transparent;
            border: 1px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .fixed-header .back-btn:hover {
            background-color: #3498db;
            border-color: #3498db;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 60px;
        }

        .filter-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: end;
        }

        .form-field {
            flex: 1;
            min-width: 150px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .load-btn {
            background-color: #3498db;
            color: white;
            height: 36px;
        }

        .load-btn:hover {
            background-color: #2980b9;
        }

        .export-btn {
            background-color: #2ecc71;
            color: white;
        }

        .export-btn:hover {
            background-color: #27ae60;
        }

        .table-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1600px;
        }

        th, td {
            padding: 10px 12px;
            text-align: center;
            border: 1px solid #ddd;
            white-space: nowrap;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        .employee-name {
            text-align: left;
            font-weight: 500;
            background-color: #f1f8ff;
            position: sticky;
            left: 0;
            z-index: 1;
        }

        .stt-column {
            background-color: #f1f8ff;
            position: sticky;
            left: 0;
            z-index: 1;
        }

        .salary-column {
            background-color: #fff9e6;
        }

        .total-column {
            background-color: #e8f5e8;
            font-weight: 600;
        }

        .signature-column {
            background-color: #f0f8ff;
        }

        input[type="number"] {
            width: 80px;
            text-align: center;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .summary-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .summary-item {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .fixed-header {
                padding: 8px 15px;
                height: 50px;
            }
            
            .fixed-header h2 {
                font-size: 1rem;
            }
            
            .fixed-header .back-btn {
                padding: 4px 8px;
                font-size: 0.85rem;
            }
            
            .container {
                padding: 10px;
                margin-top: 50px;
            }
            
            .filter-section, .table-section, .summary-section {
                padding: 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-field {
                min-width: 100%;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 0.85rem;
            }
            
            input[type="number"] {
                width: 60px;
            }
            
            .summary-row {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .fixed-header {
                padding: 6px 10px;
                height: 45px;
            }
            
            .fixed-header h2 {
                font-size: 0.9rem;
            }
            
            .container {
                padding: 8px;
                margin-top: 45px;
            }
            
            .filter-section, .table-section, .summary-section {
                padding: 12px;
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 0.8rem;
            }
            
            input[type="number"] {
                width: 50px;
                padding: 3px;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <header class="fixed-header">
        <h2>Quản Lý Đội - Tổng Hợp Lương</h2>
        <div>
            <button class="back-btn" onclick="window.location.href='dashboard.html'">Quay lại</button>
        </div>
    </header>

    <div class="container">
        <div class="filter-section">
            <h3>Lọc dữ liệu quản lý đội</h3>
            <div class="form-row">
                <div class="form-field">
                    <label for="yearSelect">Năm</label>
                    <select id="yearSelect">
                        <option value="">-- Chọn năm --</option>
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="monthSelect">Tháng</label>
                    <select id="monthSelect">
                        <option value="">-- Chọn tháng --</option>
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="weekSelect">Tuần</label>
                    <select id="weekSelect">
                        <option value="">-- Chọn tuần --</option>
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="teamSelect">Đội</label>
                    <select id="teamSelect">
                        <option value="">-- Chọn đội --</option>
                    </select>
                </div>
                
                <div class="form-field">
                    <button class="btn load-btn" id="loadDataBtn">Tải dữ liệu</button>
                </div>
            </div>
        </div>
        
        <div class="table-section">
            <h3>Bảng tổng hợp lương nhân viên</h3>
            <div id="tableContainer">
                <table id="salaryTable">
                    <thead>
                        <tr>
                            <th class="stt-column">STT</th>
                            <th class="employee-name">Họ và tên</th>
                            <th>Năm sinh</th>
                            <th>Số CCCD</th>
                            <th>Chức vụ</th>
                            <th class="salary-column">Lương ngày</th>
                            <th class="salary-column">Ngày Công tuần</th>
                            <th class="salary-column">Lương ngày công tuần</th>
                            <th class="salary-column">Số giờ tăng ca</th>
                            <th class="salary-column">Lương tăng ca</th>
                            <th class="salary-column">Lương công tăng ca</th>
                            <th class="salary-column">Tạm ứng</th>
                            <th class="total-column">Tổng lương</th>
                            <th class="total-column">Lương Thực Lĩnh</th>
                            <th class="signature-column">Ký tên</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="action-buttons">
                <button class="btn export-btn" id="exportBtn">Xuất Excel</button>
            </div>
        </div>

        <div class="summary-section">
            <h3>Tổng kết</h3>
            <div class="summary-row">
                <div class="summary-item">
                    <div>Tổng lương tuần</div>
                    <div class="summary-value" id="totalWeeklySalary">0</div>
                </div>
                <div class="summary-item">
                    <div>Tổng lương tăng ca</div>
                    <div class="summary-value" id="totalOvertimeSalary">0</div>
                </div>
                <div class="summary-item">
                    <div>Tổng tạm ứng</div>
                    <div class="summary-value" id="totalAdvance">0</div>
                </div>
                <div class="summary-item">
                    <div>Tổng lương thực lĩnh</div>
                    <div class="summary-value" id="totalNetSalary">0</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey : "AIzaSyDTOD66P7I9d9Nc-SeRySoCskl5EEquR-w" , 
            authDomain : "chamcong-9385e.firebaseapp.com" , 
            databaseURL : "https://chamcong-9385e-default-rtdb.asia-southeast1.firebasedatabase.app" , 
            projectId : "chamcong-9385e" , 
            storageBucket : "chamcong-9385e.firebasestorage.app" , 
            messagingSenderId : "416187735141" , 
            appId : "1:416187735141:web:e0a6010118ae5ce5b47a8c" 
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Biến toàn cục
        let currentUser = null;
        let teams = [];
        let employees = [];
        let currentWeekDays = [];
        let attendanceData = {};
        let overtimeData = {};
        
        // DOM Elements
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const weekSelect = document.getElementById('weekSelect');
        const teamSelect = document.getElementById('teamSelect');
        const loadDataBtn = document.getElementById('loadDataBtn');
        const tableBody = document.getElementById('tableBody');
        const exportBtn = document.getElementById('exportBtn');
        const totalWeeklySalary = document.getElementById('totalWeeklySalary');
        const totalOvertimeSalary = document.getElementById('totalOvertimeSalary');
        const totalAdvance = document.getElementById('totalAdvance');
        const totalNetSalary = document.getElementById('totalNetSalary');
        
        // Kiểm tra trạng thái đăng nhập
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                initializeForm();
                loadTeams();
            } else {
                window.location.href = 'index.html';
            }
        });
        
        // Hàm lấy đường dẫn cơ sở dữ liệu cho user hiện tại
        function getUserPath() {
            return `users/${currentUser.uid}`;
        }
        
        // Hàm khởi tạo form
        function initializeForm() {
            // Tạo danh sách năm (từ 2020 đến 2030)
            const currentYear = new Date().getFullYear();
            for (let year = 2020; year <= 2030; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            
            // Tạo danh sách tháng
            const months = [
                {value: 1, name: "Tháng 1"},
                {value: 2, name: "Tháng 2"},
                {value: 3, name: "Tháng 3"},
                {value: 4, name: "Tháng 4"},
                {value: 5, name: "Tháng 5"},
                {value: 6, name: "Tháng 6"},
                {value: 7, name: "Tháng 7"},
                {value: 8, name: "Tháng 8"},
                {value: 9, name: "Tháng 9"},
                {value: 10, name: "Tháng 10"},
                {value: 11, name: "Tháng 11"},
                {value: 12, name: "Tháng 12"}
            ];
            
            const currentMonth = new Date().getMonth() + 1;
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.name;
                if (month.value === currentMonth) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            });
            
            // Tạo danh sách tuần
            for (let week = 1; week <= 5; week++) {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = `Tuần ${week}`;
                weekSelect.appendChild(option);
            }
            
            // Thêm sự kiện khi thay đổi tháng
            monthSelect.addEventListener('change', updateWeeks);
            yearSelect.addEventListener('change', updateWeeks);
        }
        
        // Hàm cập nhật số tuần dựa trên tháng và năm
        function updateWeeks() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            
            if (!year || !month) return;
            
            // Tính số tuần trong tháng
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            // Tính tuần đầu tiên và cuối cùng
            const firstWeek = Math.ceil((firstDay.getDate() + 6 - firstDay.getDay()) / 7);
            const lastWeek = Math.ceil((lastDay.getDate() + 6 - firstDay.getDay()) / 7);
            
            // Cập nhật danh sách tuần
            weekSelect.innerHTML = '<option value="">-- Chọn tuần --</option>';
            for (let week = firstWeek; week <= lastWeek; week++) {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = `Tuần ${week}`;
                weekSelect.appendChild(option);
            }
        }
        
        // Hàm tải danh sách đội
        function loadTeams() {
            const userPath = getUserPath();
            database.ref(`${userPath}/teams`).on('value', (snapshot) => {
                teams = [];
                teamSelect.innerHTML = '<option value="">-- Chọn đội --</option>';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const team = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        teams.push(team);
                        
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        teamSelect.appendChild(option);
                    });
                }
            });
        }
        
        // Hàm tải dữ liệu và tính toán
        function loadData() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            const week = parseInt(weekSelect.value);
            const teamId = teamSelect.value;
            
            if (!year || !month || !week || !teamId) {
                alert('Vui lòng chọn đầy đủ thông tin năm, tháng, tuần và đội');
                return;
            }
            
            const userPath = getUserPath();
            
            // Tải dữ liệu nhân viên
            database.ref(`${userPath}/employees`).once('value').then((employeeSnapshot) => {
                employees = [];
                
                if (employeeSnapshot.exists()) {
                    employeeSnapshot.forEach((childSnapshot) => {
                        const employee = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        
                        if (employee.teamId === teamId) {
                            employees.push(employee);
                        }
                    });
                }
                
                // Tải dữ liệu chấm công
                const attendanceRef = database.ref(`${userPath}/attendance/${year}/${month}/week_${week}/${teamId}`);
                const overtimeRef = database.ref(`${userPath}/overtime/${year}/${month}/week_${week}/${teamId}`);
                
                Promise.all([
                    attendanceRef.once('value'),
                    overtimeRef.once('value')
                ]).then(([attendanceSnapshot, overtimeSnapshot]) => {
                    attendanceData = attendanceSnapshot.exists() ? attendanceSnapshot.val() : {};
                    overtimeData = overtimeSnapshot.exists() ? overtimeSnapshot.val() : {};
                    
                    generateSalaryTable();
                });
            });
        }
        
        // Hàm tính tổng số giờ công từ dữ liệu chấm công
        function calculateTotalHours(employeeId, data) {
            if (!data[employeeId]) return 0;
            
            let totalHours = 0;
            Object.values(data[employeeId]).forEach(hours => {
                totalHours += parseFloat(hours) || 0;
            });
            
            return totalHours;
        }
        
        // Hàm định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        // Hàm định dạng ngày tháng để hiển thị (dd/mm/yyyy)
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Hàm tạo bảng lương
        function generateSalaryTable() {
            tableBody.innerHTML = '';
            
            let totalWeekly = 0;
            let totalOvertime = 0;
            let totalAdvanceAmount = 0;
            let totalNet = 0;
            
            employees.forEach((employee, index) => {
                // Tính toán các giá trị
                const workHours = calculateTotalHours(employee.id, attendanceData);
                const overtimeHours = calculateTotalHours(employee.id, overtimeData);
                const dailySalary = parseFloat(employee.dailySalary) || 0;
                const overtimeRate = parseFloat(employee.overtimeSalary) || 0;
                
                const weeklySalary = workHours * dailySalary;
                const overtimeSalary = overtimeHours * overtimeRate;
                const advanceAmount = 0; // Có thể thêm tính năng nhập tạm ứng sau
                const totalSalary = weeklySalary + overtimeSalary;
                const netSalary = totalSalary - advanceAmount;
                
                // Cộng dồn vào tổng
                totalWeekly += weeklySalary;
                totalOvertime += overtimeSalary;
                totalAdvanceAmount += advanceAmount;
                totalNet += netSalary;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="stt-column">${index + 1}</td>
                    <td class="employee-name">${employee.name}</td>
                    <td>${formatDateForDisplay(employee.birthDate)}</td>
                    <td>${employee.idNumber}</td>
                    <td>${employee.position}</td>
                    <td class="salary-column">${formatCurrency(dailySalary)}</td>
                    <td class="salary-column">${workHours.toFixed(1)}</td>
                    <td class="salary-column">${formatCurrency(weeklySalary)}</td>
                    <td class="salary-column">${overtimeHours.toFixed(1)}</td>
                    <td class="salary-column">${formatCurrency(overtimeRate)}</td>
                    <td class="salary-column">${formatCurrency(overtimeSalary)}</td>
                    <td class="salary-column">
                        <input type="number" value="${advanceAmount}" min="0" 
                               onchange="updateAdvance(${index}, this.value)" 
                               style="width: 100px;">
                    </td>
                    <td class="total-column">${formatCurrency(totalSalary)}</td>
                    <td class="total-column">${formatCurrency(netSalary)}</td>
                    <td class="signature-column"></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Cập nhật tổng kết
            updateSummary(totalWeekly, totalOvertime, totalAdvanceAmount, totalNet);
        }
        
        // Hàm cập nhật tạm ứng
        function updateAdvance(index, value) {
            const advanceAmount = parseFloat(value) || 0;
            const rows = tableBody.querySelectorAll('tr');
            const row = rows[index];
            
            if (row) {
                const weeklySalaryText = row.cells[7].textContent;
                const overtimeSalaryText = row.cells[10].textContent;
                
                // Lấy giá trị số từ chuỗi tiền tệ
                const weeklySalary = parseFloat(weeklySalaryText.replace(/[^\d.-]/g, '')) || 0;
                const overtimeSalary = parseFloat(overtimeSalaryText.replace(/[^\d.-]/g, '')) || 0;
                
                const totalSalary = weeklySalary + overtimeSalary;
                const netSalary = totalSalary - advanceAmount;
                
                // Cập nhật các ô
                row.cells[12].textContent = formatCurrency(totalSalary);
                row.cells[13].textContent = formatCurrency(netSalary);
                
                // Tính lại tổng
                recalculateTotals();
            }
        }
        
        // Hàm tính lại tổng
        function recalculateTotals() {
            let totalWeekly = 0;
            let totalOvertime = 0;
            let totalAdvanceAmount = 0;
            let totalNet = 0;
            
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const weeklySalary = parseFloat(row.cells[7].textContent.replace(/[^\d.-]/g, '')) || 0;
                const overtimeSalary = parseFloat(row.cells[10].textContent.replace(/[^\d.-]/g, '')) || 0;
                const advanceAmount = parseFloat(row.cells[11].querySelector('input').value) || 0;
                const netSalary = parseFloat(row.cells[13].textContent.replace(/[^\d.-]/g, '')) || 0;
                
                totalWeekly += weeklySalary;
                totalOvertime += overtimeSalary;
                totalAdvanceAmount += advanceAmount;
                totalNet += netSalary;
            });
            
            updateSummary(totalWeekly, totalOvertime, totalAdvanceAmount, totalNet);
        }
        
        // Hàm cập nhật tổng kết
        function updateSummary(weekly, overtime, advance, net) {
            totalWeeklySalary.textContent = formatCurrency(weekly);
            totalOvertimeSalary.textContent = formatCurrency(overtime);
            totalAdvance.textContent = formatCurrency(advance);
            totalNetSalary.textContent = formatCurrency(net);
        }
        
        // Hàm xuất Excel (đơn giản)
        function exportToExcel() {
            // Tạo nội dung CSV
            let csvContent = "STT,Họ và tên,Năm sinh,Số CCCD,Chức vụ,Lương ngày,Ngày Công tuần,Lương ngày công tuần,Số giờ tăng ca,Lương tăng ca,Lương công tăng ca,Tạm ứng,Tổng lương,Lương Thực Lĩnh,Ký tên\n";
            
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const cells = row.cells;
                const rowData = [
                    index + 1,
                    cells[1].textContent,
                    cells[2].textContent,
                    cells[3].textContent,
                    cells[4].textContent,
                    cells[5].textContent.replace(/[^\d.-]/g, ''),
                    cells[6].textContent,
                    cells[7].textContent.replace(/[^\d.-]/g, ''),
                    cells[8].textContent,
                    cells[9].textContent.replace(/[^\d.-]/g, ''),
                    cells[10].textContent.replace(/[^\d.-]/g, ''),
                    cells[11].querySelector('input').value,
                    cells[12].textContent.replace(/[^\d.-]/g, ''),
                    cells[13].textContent.replace(/[^\d.-]/g, ''),
                    ""
                ];
                csvContent += rowData.join(',') + '\n';
            });
            
            // Tạo file và tải xuống
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bang_luong_${yearSelect.value}_${monthSelect.value}_tuan_${weekSelect.value}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Event Listeners
        loadDataBtn.addEventListener('click', loadData);
        exportBtn.addEventListener('click', exportToExcel);
    </script>
</body>
</html>